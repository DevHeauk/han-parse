<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œê¸€ íŒŒì¼ íŒŒì„œ - ì›¹ ì—ë””í„°</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&family=Nanum+Myeongjo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --hwp-primary: #c47f5a;
            --hwp-accent: #8b5a3c;
            --hwp-bg: linear-gradient(135deg, #d4a574 0%, #c47f5a 100%);
            --hwp-light: #faf5f0;
            
            --hwpx-primary: #06b6d4;
            --hwpx-accent: #0891b2;
            --hwpx-bg: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            --hwpx-light: #ecfeff;
            
            --text-primary: #1a1a2e;
            --text-secondary: #4a4a5a;
            --border-color: #d0d0d0;
            --success: #10b981;
            --error: #ef4444;
            
            --active-primary: var(--hwp-primary);
            --active-accent: var(--hwp-accent);
            --active-bg: var(--hwp-bg);
            --active-light: var(--hwp-light);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: var(--active-bg);
            min-height: 100vh;
            padding: 20px;
            transition: background 0.5s ease;
        }

        body.hwpx-mode {
            --active-primary: var(--hwpx-primary);
            --active-accent: var(--hwpx-accent);
            --active-bg: var(--hwpx-bg);
            --active-light: var(--hwpx-light);
            background: var(--hwpx-bg);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        /* Tab Header */
        .tab-header {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid var(--border-color);
        }

        .tab-btn {
            flex: 1;
            padding: 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-family: inherit;
            font-size: 1.05em;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .tab-btn.hwp-tab:hover, .tab-btn.hwp-tab.active {
            background: var(--hwp-light);
            color: var(--hwp-primary);
        }

        .tab-btn.hwpx-tab:hover, .tab-btn.hwpx-tab.active {
            background: var(--hwpx-light);
            color: var(--hwpx-primary);
        }

        .tab-btn.active { border-bottom: 3px solid var(--active-primary); }

        .tab-badge {
            font-size: 0.75em;
            padding: 3px 10px;
            border-radius: 20px;
            background: #e0e0e0;
        }

        .tab-btn.hwpx-tab .tab-badge { background: #d1fae5; color: #059669; }

        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }

        /* Toolbar */
        .toolbar {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            background: #fafafa;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            align-items: center;
        }

        .toolbar-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .toolbar-divider {
            width: 1px;
            height: 30px;
            background: var(--border-color);
            margin: 0 10px;
        }

        .toolbar-btn {
            padding: 10px 18px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .toolbar-btn:hover { background: #f0f0f0; border-color: var(--active-primary); }
        .toolbar-btn.primary { background: var(--active-primary); color: white; border-color: var(--active-primary); }
        .toolbar-btn.primary:hover { background: var(--active-accent); }
        .toolbar-btn.success { background: var(--success); color: white; border-color: var(--success); }
        .toolbar-btn.success:hover { opacity: 0.9; }

        .filename-input {
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.9em;
            width: 200px;
        }

        /* Upload Section */
        .upload-section {
            background: var(--active-light);
            border: 3px dashed var(--active-primary);
            border-radius: 16px;
            padding: 60px 40px;
            text-align: center;
            transition: all 0.3s;
        }

        .upload-section:hover, .upload-section.dragover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .upload-icon { font-size: 3.5em; margin-bottom: 20px; }
        .upload-title { font-size: 1.4em; font-weight: 700; margin-bottom: 10px; }
        .upload-subtitle { color: var(--text-secondary); margin-bottom: 25px; }

        .file-input-wrapper { position: relative; display: inline-block; }
        .file-input { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        .file-input-label {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 16px 35px;
            background: var(--active-primary);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 600;
            transition: all 0.3s;
        }
        .file-input-label:hover { background: var(--active-accent); transform: translateY(-2px); }

        /* Document View - ë¬¸ì„œ í¸ì§‘ê¸° ìŠ¤íƒ€ì¼ */
        .document-view {
            display: none;
            flex-direction: column;
        }

        .document-view.show { display: flex; }

        .document-paper {
            background: white;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            padding: 60px 80px;
            min-height: 800px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            font-family: 'Nanum Myeongjo', serif;
            font-size: 11pt;
            line-height: 1.8;
        }

        .document-title {
            text-align: center;
            font-size: 18pt;
            font-weight: 700;
            margin-bottom: 40px;
            color: var(--text-primary);
        }

        /* Table Styles - í•œê¸€ ë¬¸ì„œ ìŠ¤íƒ€ì¼ */
        .doc-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 10pt;
        }

        .doc-table th, .doc-table td {
            border: 1px solid #333;
            padding: 10px 12px;
            text-align: left;
            vertical-align: middle;
        }

        .doc-table th {
            background: #f0f0f0;
            font-weight: 600;
            text-align: center;
        }

        .doc-table .header-cell {
            background: #e8e8e8;
            font-weight: 600;
            text-align: center;
        }

        .doc-table .editable-cell {
            padding: 0;
        }

        .doc-table .editable-cell input {
            width: 100%;
            padding: 10px 12px;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: inherit;
            outline: none;
            transition: background 0.2s;
        }

        .doc-table .editable-cell input:focus {
            background: #fff8e1;
            outline: 2px solid var(--active-primary);
            outline-offset: -2px;
        }

        .doc-table .editable-cell input:hover:not(:focus) {
            background: #f5f5f5;
        }

        /* Text Content */
        .doc-text-section {
            margin: 30px 0;
        }

        .doc-text-section h3 {
            font-size: 12pt;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #333;
        }

        .doc-textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: 'Nanum Myeongjo', serif;
            font-size: 11pt;
            line-height: 1.8;
            resize: vertical;
        }

        .doc-textarea:focus {
            outline: 2px solid var(--active-primary);
            outline-offset: -2px;
        }

        /* File Info Bar */
        .file-info-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9em;
        }

        .file-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 20px;
        }

        .file-type-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .file-type-badge.readonly { background: #fef3c7; color: #d97706; }
        .file-type-badge.editable { background: #d1fae5; color: #059669; }

        /* Alert */
        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 10px;
            z-index: 1000;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s;
            max-width: 380px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .alert.show { transform: translateX(0); opacity: 1; }
        .alert-success { background: #ecfdf5; color: #065f46; border: 1px solid var(--success); }
        .alert-error { background: #fef2f2; color: #991b1b; border: 1px solid var(--error); }

        /* Loading */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95);
            z-index: 999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 20px;
        }

        .loading-overlay.show { display: flex; }

        .spinner {
            width: 45px;
            height: 45px;
            border: 4px solid #e0e0e0;
            border-top-color: var(--active-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Stats */
        .stats-bar {
            display: flex;
            gap: 20px;
            margin-left: auto;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .stat-value { font-weight: 700; color: var(--active-primary); }

        /* Format Toolbar */
        .format-toolbar {
            gap: 2px !important;
        }
        
        .format-btn {
            width: 32px !important;
            height: 32px !important;
            padding: 0 !important;
            display: flex !important;
            align-items: center;
            justify-content: center;
            font-size: 14px !important;
            font-family: Georgia, serif;
        }
        
        .format-btn strong { font-weight: 900; }
        .format-btn em { font-style: italic; }
        .format-btn u { text-decoration: underline; }
        .format-btn s { text-decoration: line-through; }
        
        .format-btn.active {
            background: var(--active-primary) !important;
            color: white !important;
        }
        
        /* Editable Cell Styles */
        .editable-cell {
            padding: 8px 12px;
            min-height: 1.5em;
            outline: none;
        }
        
        .editable-cell:focus {
            background: #fffef0;
            box-shadow: inset 0 0 0 2px var(--active-primary);
        }
        
        .editable-cell b, .editable-cell strong { font-weight: bold; }
        .editable-cell i, .editable-cell em { font-style: italic; }
        .editable-cell u { text-decoration: underline; }
        .editable-cell s, .editable-cell strike { text-decoration: line-through; }
        
        /* Text Alignment */
        .text-left { text-align: left; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }

        /* Responsive */
        @media (max-width: 768px) {
            .document-paper { padding: 30px 20px; }
            .toolbar { flex-direction: column; }
            .toolbar-group { width: 100%; justify-content: center; }
            .toolbar-divider { display: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Tab Header -->
        <div class="tab-header">
            <button class="tab-btn hwp-tab active" onclick="switchTab('hwp')">
                ğŸ“„ HWP íŒŒì¼
                <span class="tab-badge">ì½ê¸° ì „ìš©</span>
            </button>
            <button class="tab-btn hwpx-tab" onclick="switchTab('hwpx')">
                ğŸ“ HWPX íŒŒì¼
                <span class="tab-badge">í¸ì§‘ ê°€ëŠ¥</span>
            </button>
        </div>

        <!-- HWP Tab -->
        <div id="hwpTab" class="tab-content active">
            <!-- Upload -->
            <div class="upload-section" id="hwpUpload">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-title">HWP íŒŒì¼ ì—…ë¡œë“œ</div>
                <div class="upload-subtitle">íŒŒì¼ì„ ë“œë˜ê·¸ ì•¤ ë“œë¡­í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒ<br><small>ì½ê¸° ì „ìš© - CSV/JSONìœ¼ë¡œ ì¶”ì¶œ ê°€ëŠ¥</small></div>
                <div class="file-input-wrapper">
                    <input type="file" id="hwpFileInput" class="file-input" accept=".hwp,.HWP">
                    <label for="hwpFileInput" class="file-input-label">ğŸ“‚ HWP íŒŒì¼ ì„ íƒ</label>
                </div>
            </div>

            <!-- Document View -->
            <div class="document-view" id="hwpDocView">
                <div class="file-info-bar">
                    <div class="file-badge">
                        ğŸ“„ <span id="hwpFileName">íŒŒì¼ëª….hwp</span>
                    </div>
                    <span class="file-type-badge readonly">ì½ê¸° ì „ìš©</span>
                    <div class="stats-bar">
                        <div class="stat-item">í‘œ <span class="stat-value" id="hwpTableCount">0</span>ê°œ</div>
                        <div class="stat-item">í…ìŠ¤íŠ¸ <span class="stat-value" id="hwpTextLen">0</span>ì</div>
                    </div>
                </div>

                <div class="toolbar">
                    <div class="toolbar-group">
                        <button class="toolbar-btn" onclick="resetHwp()">ğŸ”„ ìƒˆ íŒŒì¼</button>
                        <button class="toolbar-btn primary" onclick="saveHwpChanges()">ğŸ’¾ ì €ì¥</button>
                    </div>
                    <div class="toolbar-divider"></div>
                    <div class="toolbar-group">
                        <input type="text" class="filename-input" id="hwpOutputFilename" placeholder="íŒŒì¼ëª…">
                        <button class="toolbar-btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" onclick="convertHwpToHwpx()">ğŸ”„ HWPXë¡œ ë³€í™˜</button>
                        <button class="toolbar-btn success" onclick="downloadHwpPackage()">ğŸ“¥ ZIP</button>
                        <button class="toolbar-btn" onclick="downloadHwpCsv()">ğŸ“Š CSV</button>
                        <button class="toolbar-btn" onclick="downloadHwpJson()">ğŸ“„ JSON</button>
                    </div>
                </div>

                <div class="document-paper" id="hwpDocPaper">
                    <!-- ë¬¸ì„œ ë‚´ìš©ì´ ì—¬ê¸°ì— ë Œë”ë§ë¨ -->
                </div>
            </div>
        </div>

        <!-- HWPX Tab -->
        <div id="hwpxTab" class="tab-content">
            <!-- Upload -->
            <div class="upload-section" id="hwpxUpload">
                <div class="upload-icon">âœ¨</div>
                <div class="upload-title">HWPX íŒŒì¼ ì—…ë¡œë“œ</div>
                <div class="upload-subtitle">íŒŒì¼ì„ ë“œë˜ê·¸ ì•¤ ë“œë¡­í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒ<br><small>âœ… í¸ì§‘ í›„ HWPX íŒŒì¼ë¡œ ì €ì¥ ê°€ëŠ¥!</small></div>
                <div class="file-input-wrapper">
                    <input type="file" id="hwpxFileInput" class="file-input" accept=".hwpx,.HWPX">
                    <label for="hwpxFileInput" class="file-input-label">ğŸ“‚ HWPX íŒŒì¼ ì„ íƒ</label>
                </div>
            </div>

            <!-- Document View -->
            <div class="document-view" id="hwpxDocView">
                <div class="file-info-bar">
                    <div class="file-badge">
                        ğŸ“ <span id="hwpxFileName">íŒŒì¼ëª….hwpx</span>
                    </div>
                    <span class="file-type-badge editable">âœ… í¸ì§‘ ê°€ëŠ¥</span>
                    <div class="stats-bar">
                        <div class="stat-item">í‘œ <span class="stat-value" id="hwpxTableCount">0</span>ê°œ</div>
                        <div class="stat-item">í…ìŠ¤íŠ¸ <span class="stat-value" id="hwpxTextLen">0</span>ì</div>
                    </div>
                </div>

                <div class="toolbar">
                    <div class="toolbar-group">
                        <button class="toolbar-btn" onclick="resetHwpx()">ğŸ”„ ìƒˆ íŒŒì¼</button>
                        <button class="toolbar-btn primary" onclick="saveHwpxAll()">ğŸ’¾ ì €ì¥</button>
                    </div>
                    <div class="toolbar-divider"></div>
                    <!-- ì„œì‹ í¸ì§‘ ë²„íŠ¼ -->
                    <div class="toolbar-group format-toolbar">
                        <button class="toolbar-btn format-btn" onclick="formatText('bold')" title="êµµê²Œ (Ctrl+B)">
                            <strong>B</strong>
                        </button>
                        <button class="toolbar-btn format-btn" onclick="formatText('italic')" title="ê¸°ìš¸ì„ (Ctrl+I)">
                            <em>I</em>
                        </button>
                        <button class="toolbar-btn format-btn" onclick="formatText('underline')" title="ë°‘ì¤„ (Ctrl+U)">
                            <u>U</u>
                        </button>
                        <button class="toolbar-btn format-btn" onclick="formatText('strikethrough')" title="ì·¨ì†Œì„ ">
                            <s>S</s>
                        </button>
                    </div>
                    <div class="toolbar-divider"></div>
                    <div class="toolbar-group format-toolbar">
                        <button class="toolbar-btn format-btn" onclick="alignText('left')" title="ì™¼ìª½ ì •ë ¬">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h18v2H3V3zm0 4h12v2H3V7zm0 4h18v2H3v-2zm0 4h12v2H3v-2zm0 4h18v2H3v-2z"/></svg>
                        </button>
                        <button class="toolbar-btn format-btn" onclick="alignText('center')" title="ê°€ìš´ë° ì •ë ¬">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h18v2H3V3zm3 4h12v2H6V7zm-3 4h18v2H3v-2zm3 4h12v2H6v-2zm-3 4h18v2H3v-2z"/></svg>
                        </button>
                        <button class="toolbar-btn format-btn" onclick="alignText('right')" title="ì˜¤ë¥¸ìª½ ì •ë ¬">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h18v2H3V3zm6 4h12v2H9V7zm-6 4h18v2H3v-2zm6 4h12v2H9v-2zm-6 4h18v2H3v-2z"/></svg>
                        </button>
                    </div>
                    <div class="toolbar-divider"></div>
                    <div class="toolbar-group">
                        <input type="text" class="filename-input" id="hwpxOutputFilename" placeholder="íŒŒì¼ëª…">
                        <button class="toolbar-btn success" onclick="downloadHwpxFile()">ğŸ“¥ HWPX ë‹¤ìš´ë¡œë“œ</button>
                        <button class="toolbar-btn" onclick="downloadHwpxCsv()">ğŸ“Š CSV</button>
                    </div>
                </div>

                <div class="document-paper" id="hwpxDocPaper" contenteditable="false">
                    <!-- ë¬¸ì„œ ë‚´ìš©ì´ ì—¬ê¸°ì— ë Œë”ë§ë¨ -->
                </div>
            </div>
        </div>
    </div>

    <!-- Alert -->
    <div class="alert" id="alert"></div>

    <!-- Loading -->
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <div>íŒŒì¼ ì²˜ë¦¬ ì¤‘...</div>
    </div>

    <script>
        // State
        let hwpState = { sessionId: null, tables: [], text: '' };
        let hwpxState = { sessionId: null, tables: [], text: '' };

        // Tab Switch
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (tab === 'hwp') {
                document.querySelector('.hwp-tab').classList.add('active');
                document.getElementById('hwpTab').classList.add('active');
                document.body.classList.remove('hwpx-mode');
            } else {
                document.querySelector('.hwpx-tab').classList.add('active');
                document.getElementById('hwpxTab').classList.add('active');
                document.body.classList.add('hwpx-mode');
            }
        }

        // Event Listeners
        document.getElementById('hwpFileInput').addEventListener('change', e => handleFile(e.target.files[0], 'hwp'));
        document.getElementById('hwpxFileInput').addEventListener('change', e => handleFile(e.target.files[0], 'hwpx'));

        // Drag & Drop
        ['hwpUpload', 'hwpxUpload'].forEach(id => {
            const el = document.getElementById(id);
            const type = id.includes('hwpx') ? 'hwpx' : 'hwp';
            const ext = '.' + type;
            
            el.addEventListener('dragover', e => { e.preventDefault(); el.classList.add('dragover'); });
            el.addEventListener('dragleave', e => { e.preventDefault(); el.classList.remove('dragover'); });
            el.addEventListener('drop', e => {
                e.preventDefault();
                el.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && file.name.toLowerCase().endsWith(ext)) {
                    handleFile(file, type);
                } else {
                    showAlert(`${ext.toUpperCase()} íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤`, 'error');
                }
            });
        });

        // File Upload
        async function handleFile(file, type) {
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            showLoading(true);

            try {
                const response = await fetch('/api/upload', { method: 'POST', body: formData });
                const data = await response.json();

                if (response.ok && data.success) {
                    if (type === 'hwp') processHwpResult(data);
                    else processHwpxResult(data);
                    showAlert(data.message, 'success');
                } else {
                    showAlert(data.error || 'ì—…ë¡œë“œ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                showAlert('ì˜¤ë¥˜: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Process Results
        function processHwpResult(data) {
            hwpState = {
                sessionId: data.session_id,
                tables: data.tables || [],
                text: data.text || ''
            };

            document.getElementById('hwpUpload').style.display = 'none';
            document.getElementById('hwpDocView').classList.add('show');
            document.getElementById('hwpFileName').textContent = data.filename;
            document.getElementById('hwpOutputFilename').value = data.filename.replace(/\.hwp$/i, '') + '_edited';
            document.getElementById('hwpTableCount').textContent = data.table_count;
            document.getElementById('hwpTextLen').textContent = data.text ? data.text.length : 0;

            renderDocument('hwp', hwpState);
        }

        function processHwpxResult(data) {
            hwpxState = {
                sessionId: data.session_id,
                tables: data.tables || [],
                text: data.text || ''
            };

            document.getElementById('hwpxUpload').style.display = 'none';
            document.getElementById('hwpxDocView').classList.add('show');
            document.getElementById('hwpxFileName').textContent = data.filename;
            document.getElementById('hwpxOutputFilename').value = data.filename.replace(/\.hwpx$/i, '') + '_edited';
            document.getElementById('hwpxTableCount').textContent = data.table_count;
            document.getElementById('hwpxTextLen').textContent = data.text ? data.text.length : 0;

            renderDocument('hwpx', hwpxState);
        }

        // Render Document
        function renderDocument(type, state) {
            const paper = document.getElementById(type + 'DocPaper');
            let html = '';

            // í‘œë“¤ ë Œë”ë§
            state.tables.forEach((table, tableIdx) => {
                html += renderTable(type, table, tableIdx);
            });

            // í…ìŠ¤íŠ¸ ì„¹ì…˜
            if (state.text) {
                html += `
                    <div class="doc-text-section">
                        <h3>ğŸ“ ì¶”ì¶œëœ í…ìŠ¤íŠ¸</h3>
                        <textarea class="doc-textarea" 
                            data-type="${type}" 
                            onchange="updateText('${type}', this.value)">${escapeHtml(state.text)}</textarea>
                    </div>
                `;
            }

            paper.innerHTML = html || '<p style="text-align:center;color:#999;">ë¬¸ì„œ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        // Render Table with colspan/rowspan support
        function renderTable(type, table, tableIdx) {
            const cells = table.cells || [];
            const rows = table.rows || [];
            
            let html = '<table class="doc-table">';
            
            rows.forEach((row, rowIdx) => {
                html += '<tr>';
                
                row.forEach((cellText, colIdx) => {
                    // ì…€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    const cellInfo = cells[rowIdx] ? cells[rowIdx][colIdx] : null;
                    const colspan = cellInfo ? cellInfo.colspan : 1;
                    const rowspan = cellInfo ? cellInfo.rowspan : 1;
                    
                    // ì²« í–‰ ë˜ëŠ” ì²« ì—´ì€ í—¤ë”ë¡œ ì²˜ë¦¬
                    const isHeader = rowIdx === 0 || colIdx === 0;
                    
                    let spanAttrs = '';
                    if (colspan > 1) spanAttrs += ` colspan="${colspan}"`;
                    if (rowspan > 1) spanAttrs += ` rowspan="${rowspan}"`;
                    
                    if (isHeader && cellText) {
                        html += `<td class="header-cell"${spanAttrs}>${escapeHtml(cellText)}</td>`;
                    } else {
                        html += `<td class="editable-cell"${spanAttrs}>
                            <input type="text" 
                                value="${escapeHtml(cellText)}" 
                                data-type="${type}"
                                data-table="${tableIdx}" 
                                data-row="${rowIdx}" 
                                data-col="${colIdx}"
                                onchange="updateCell('${type}', ${tableIdx}, ${rowIdx}, ${colIdx}, this.value)">
                        </td>`;
                    }
                });
                
                html += '</tr>';
            });
            
            html += '</table>';
            return html;
        }

        // Update Functions
        function updateCell(type, tableIdx, rowIdx, colIdx, value) {
            const state = type === 'hwp' ? hwpState : hwpxState;
            if (state.tables[tableIdx] && state.tables[tableIdx].rows[rowIdx]) {
                state.tables[tableIdx].rows[rowIdx][colIdx] = value;
            }
        }

        function updateText(type, value) {
            if (type === 'hwp') hwpState.text = value;
            else hwpxState.text = value;
        }

        // Save Functions
        async function saveHwpChanges() {
            if (!hwpState.sessionId) return;
            
            try {
                await Promise.all([
                    fetch(`/api/tables/${hwpState.sessionId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ tables: hwpState.tables })
                    }),
                    fetch(`/api/text/${hwpState.sessionId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: hwpState.text })
                    })
                ]);
                showAlert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            } catch (e) {
                showAlert('ì €ì¥ ì‹¤íŒ¨', 'error');
            }
        }

        async function saveHwpxAll() {
            if (!hwpxState.sessionId) return;
            
            try {
                await Promise.all([
                    fetch(`/api/tables/${hwpxState.sessionId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ tables: hwpxState.tables })
                    }),
                    fetch(`/api/text/${hwpxState.sessionId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: hwpxState.text })
                    })
                ]);
                showAlert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            } catch (e) {
                showAlert('ì €ì¥ ì‹¤íŒ¨', 'error');
            }
        }

        // Download Functions
        async function downloadHwpPackage() {
            if (!hwpState.sessionId) return;
            await saveHwpChanges();
            
            const filename = document.getElementById('hwpOutputFilename').value.trim() || 'edited';
            
            try {
                const response = await fetch(`/api/download/${hwpState.sessionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                if (response.ok) {
                    const blob = await response.blob();
                    downloadBlob(blob, filename + '.zip');
                    showAlert('ZIP ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'success');
                }
            } catch (e) {
                showAlert('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨', 'error');
            }
        }

        function downloadHwpCsv() {
            if (!hwpState.tables.length) return;
            const filename = document.getElementById('hwpOutputFilename').value.trim() || 'tables';
            const csv = tablesToCsv(hwpState.tables);
            downloadBlob(new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' }), filename + '.csv');
            showAlert('CSV ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'success');
        }

        function downloadHwpJson() {
            if (!hwpState.tables.length) return;
            const filename = document.getElementById('hwpOutputFilename').value.trim() || 'tables';
            downloadBlob(new Blob([JSON.stringify(hwpState.tables, null, 2)], { type: 'application/json' }), filename + '.json');
            showAlert('JSON ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'success');
        }

        async function convertHwpToHwpx() {
            if (!hwpState.sessionId) {
                showAlert('ë¨¼ì € HWP íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            const filename = document.getElementById('hwpOutputFilename').value.trim() || 'converted';
            showLoading(true);
            
            try {
                const response = await fetch(`/api/convert-hwp-to-hwpx/${hwpState.sessionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: filename })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    downloadBlob(blob, filename.endsWith('.hwpx') ? filename : filename + '.hwpx');
                    showAlert('HWPX ë³€í™˜ ì™„ë£Œ! ì´ì œ í¸ì§‘ ê°€ëŠ¥í•œ HWPX íŒŒì¼ì…ë‹ˆë‹¤. HWPX íƒ­ì—ì„œ ì—´ì–´ë³´ì„¸ìš”.', 'success');
                } else {
                    const data = await response.json();
                    showAlert(data.error || 'ë³€í™˜ ì‹¤íŒ¨', 'error');
                }
            } catch (e) {
                showAlert('ë³€í™˜ ì‹¤íŒ¨: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function downloadHwpxFile() {
            if (!hwpxState.sessionId) return;
            await saveHwpxAll();
            
            const filename = document.getElementById('hwpxOutputFilename').value.trim() || 'edited';
            showLoading(true);

            try {
                const response = await fetch(`/api/download-hwpx/${hwpxState.sessionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: filename })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    downloadBlob(blob, filename.endsWith('.hwpx') ? filename : filename + '.hwpx');
                    showAlert('HWPX íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ! í•œê¸€ì—ì„œ ì—´ì–´ë³´ì„¸ìš”.', 'success');
                } else {
                    const data = await response.json();
                    showAlert(data.error || 'ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨', 'error');
                }
            } catch (e) {
                showAlert('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨', 'error');
            } finally {
                showLoading(false);
            }
        }

        function downloadHwpxCsv() {
            if (!hwpxState.tables.length) return;
            const filename = document.getElementById('hwpxOutputFilename').value.trim() || 'tables';
            const csv = tablesToCsv(hwpxState.tables);
            downloadBlob(new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' }), filename + '.csv');
            showAlert('CSV ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'success');
        }

        // Reset Functions
        function resetHwp() {
            hwpState = { sessionId: null, tables: [], text: '' };
            document.getElementById('hwpUpload').style.display = 'block';
            document.getElementById('hwpDocView').classList.remove('show');
            document.getElementById('hwpFileInput').value = '';
        }

        function resetHwpx() {
            hwpxState = { sessionId: null, tables: [], text: '' };
            document.getElementById('hwpxUpload').style.display = 'block';
            document.getElementById('hwpxDocView').classList.remove('show');
            document.getElementById('hwpxFileInput').value = '';
        }

        // =========== ì„œì‹ í¸ì§‘ ê¸°ëŠ¥ ===========
        
        // í…ìŠ¤íŠ¸ ì„œì‹ ì ìš© (êµµê²Œ, ê¸°ìš¸ì„, ë°‘ì¤„, ì·¨ì†Œì„ )
        function formatText(command) {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;
            
            // document.execCommand ì‚¬ìš© (deprecated ë˜ì—ˆì§€ë§Œ ì—¬ì „íˆ ì‘ë™)
            document.execCommand(command, false, null);
            
            // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
            updateFormatButtons();
        }
        
        // í…ìŠ¤íŠ¸ ì •ë ¬ ì ìš©
        function alignText(alignment) {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;
            
            // í˜„ì¬ ì…€ ë˜ëŠ” ë¶€ëª¨ ìš”ì†Œ ì°¾ê¸°
            let node = selection.anchorNode;
            while (node && !node.classList?.contains('editable-cell')) {
                node = node.parentNode;
            }
            
            if (node) {
                node.classList.remove('text-left', 'text-center', 'text-right');
                node.classList.add('text-' + alignment);
            }
        }
        
        // ì„œì‹ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateFormatButtons() {
            const buttons = document.querySelectorAll('.format-btn');
            buttons.forEach(btn => {
                const command = btn.getAttribute('onclick')?.match(/'(\w+)'/)?.[1];
                if (command && ['bold', 'italic', 'underline', 'strikethrough'].includes(command)) {
                    if (document.queryCommandState(command)) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                }
            });
        }
        
        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì§€ì›
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + B (êµµê²Œ)
            if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                e.preventDefault();
                formatText('bold');
            }
            // Ctrl/Cmd + I (ê¸°ìš¸ì„)
            if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
                e.preventDefault();
                formatText('italic');
            }
            // Ctrl/Cmd + U (ë°‘ì¤„)
            if ((e.ctrlKey || e.metaKey) && e.key === 'u') {
                e.preventDefault();
                formatText('underline');
            }
        });
        
        // ì„ íƒ ë³€ê²½ ì‹œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        document.addEventListener('selectionchange', updateFormatButtons);

        // Utilities
        function tablesToCsv(tables) {
            let csv = '';
            tables.forEach((table, idx) => {
                if (idx > 0) csv += '\n\n';
                csv += `=== í‘œ ${idx + 1} ===\n`;
                table.rows.forEach(row => {
                    csv += row.map(cell => {
                        if (cell.includes(',') || cell.includes('"') || cell.includes('\n')) {
                            return '"' + cell.replace(/"/g, '""') + '"';
                        }
                        return cell;
                    }).join(',') + '\n';
                });
            });
            return csv;
        }

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert alert-${type} show`;
            setTimeout(() => alert.classList.remove('show'), 4000);
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('show', show);
        }
    </script>
</body>
</html>
